<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Android QA Tool</title>
        <link href="static/css/style.css" rel="stylesheet" />
    </head>
    <body>
        <div id="section">
            <p>Profiles</p>
            <label for="deviceNameField">Profile Name:</label>
            <input type="text" id="deviceNameField" rows="1" cols="30" />
            <button id="profileSaveButton">Save this profile</button>
            <br />
            *Please ensure Device IP field is correct before saving profile(It will assign the IP to the profile name).
            If connected, it will save the device model also
            <br />
            Any logs will be sent to the Connection Status field.
            <p></p>
            <div class="dropdown">
                <select name="deviceProfiles" id="deviceProfileNames" cols="5" width="500px">
                    <option value="">Click here to choose profile (Profile Name | IP Address | Device)</option>
                </select>
                <button id="profileRemoveButton">Remove Profile</button>
            </div>

            <p>Connection</p>
            <label for="deviceConnectionField">Devices:</label>
            <textarea id="deviceConnectionField" rows="2" cols="50" readonly>No devices</textarea>
            <br />
            <br />
            <label for="deviceStatusField">Status:</label>
            <textarea id="deviceStatusField" rows="3" cols="50" readonly>Chilling</textarea>
            <br />
            <br />
            <label for="deviceIPField">Device:</label>
            <input type="text" id="deviceIPField" rows="1" cols="30" />
            <button id="connectButton">Connect</button>
            <button id="disconnectButton">Disconnect</button>
            <button id="stopAdbButton">Stop ADB</button>
        </div>
        <div id="section">
            <p>Application</p>
            <label for="directoryField">APK directory:</label>
            <textarea id="directoryField" rows="2" cols="35" readonly>I'm lost, point me somewhere -></textarea>
            <button id="directoryButton">Browse</button>
            <p></p>
            <label for="packageField">APK Package Name:</label>
            <input type="text" id="packageField" rows="1" cols="30" value="com.freecast.watch" />
            <br />
            <br />
            <button id="installButton">Install APK</button>
            <button id="startButton">Start APK</button>
            <button id="stopButton">Stop APK</button>
            <button id="clearButton">Clear Cache</button>
            <button id="uninstallButton">Uninstall APK</button>
            <p></p>
            <label for="installStatusField">Result:</label>
            <textarea id="installStatusField" rows="5" cols="60" readonly>Not much is happening at the moment</textarea>
        </div>
        <div id="section">
            <p>Actions</p>
            <label for="typeInput">Send Text to Device Input:</label>
            <input type="text" id="typeInput" rows="1" cols="60" />
            <button id="typeButton">Send</button>
            <button id="backspaceButton">Backspace</button>
        </div>
        <script>
            const electron = require("electron")
            const { ipcRenderer } = electron

            //profile
            let currentProfile = {}
            let currentConfig = {}
            let currentDevice = {}

            //inputs
            const deviceInput = document.getElementById("deviceIPField")
            const apkInput = document.getElementById("packageField")
            const typeInput = document.getElementById("typeInput")
            const saveInput = document.getElementById("deviceNameField")
            const profileNamesList = document.getElementById("deviceProfileNames")

            //fields
            const deviceConnectionStatus = document.getElementById("deviceConnectionField")
            const deviceStatus = document.getElementById("deviceStatusField")
            const installStatus = document.getElementById("installStatusField")
            const directoryField = document.getElementById("directoryField")

            //buttons
            const profileSaveButton = document.getElementById("profileSaveButton")
            const profileLoadButton = document.getElementById("profileLoadButton")
            const profileRemoveButton = document.getElementById("profileRemoveButton")
            const connectButton = document.getElementById("connectButton")
            const disconnectButton = document.getElementById("disconnectButton")
            const stopAdbButton = document.getElementById("stopAdbButton")
            const installButton = document.getElementById("installButton")
            const directoryButton = document.getElementById("directoryButton")
            const startButton = document.getElementById("startButton")
            const stopButton = document.getElementById("stopButton")
            const clearButton = document.getElementById("clearButton")
            const typeInputButton = document.getElementById("typeButton")
            const backspaceButton = document.getElementById("backspaceButton")
            const uninstallButton = document.getElementById("uninstallButton")

            ipcRenderer.send("checkDevices")

            deviceInput.onkeydown = function (e) {
                if (e.keyCode == 13) {
                    connectButton.click()
                }
            }

            typeInput.onkeydown = function (e) {
                if (e.keyCode == 13) {
                    typeInputButton.click()
                }
            }

            profileNamesList.addEventListener("change", function handleChange(event) {
                currentProfile = {}
                let selectedOption = event.target.options[event.target.selectedIndex]
                currentProfile.name = selectedOption.getAttribute("name")
                currentProfile.ip = selectedOption.getAttribute("value")
                currentProfile.model = selectedOption.getAttribute("model")

                // Do by default
                deviceInput.value = currentProfile.ip

                if (currentProfile.name) {
                    deviceStatus.value = `Loaded profile: ${currentProfile.name}`
                }
            })

            profileSaveButton.addEventListener("click", () => {
                let newDeviceProfile = {
                    name: saveInput.value,
                    ip: deviceInput.value,
                    model: currentDevice?.model
                }
                let profileIndex = currentConfig.deviceProfiles.findIndex(
                    (profile) => profile.name === newDeviceProfile.name
                )

                currentDevice = newDeviceProfile

                if (profileIndex > -1) {
                    currentConfig.deviceProfiles[profileIndex] = newDeviceProfile
                    deviceStatus.value = `Updated profile: ${newDeviceProfile.name}\n`
                } else {
                    currentConfig.deviceProfiles.push(newDeviceProfile)
                    deviceStatus.value = `Added profile: ${newDeviceProfile.name}\n`
                }

                ipcRenderer.send("updateConfig", ["add", currentConfig])
                ipcRenderer.send("refreshConfig")
            })

            profileRemoveButton.addEventListener("click", () => {
                let profileIndex = currentConfig.deviceProfiles.findIndex(
                    (profile) => profile.name === currentProfile.name
                )

                currentConfig.deviceProfiles.splice(profileIndex, 1)

                if (profileIndex > -1) {
                    deviceStatus.value = `Removed profile: ${currentProfile.name}\n`
                    ipcRenderer.send("updateConfig", ["remove", currentConfig])
                } else {
                    deviceStatus.value = `Failed to remove profile: ${currentProfile.name}\n`
                }
                
                ipcRenderer.send("refreshConfig")
            })

            connectButton.addEventListener("click", () => {
                deviceStatus.value = `Running...`

                currentDevice.ip = deviceInput.value

                ipcRenderer.send("connectDevice", deviceInput.value)
            })

            disconnectButton.addEventListener("click", () => {
                ipcRenderer.send("disconnectDevice")
            })

            stopAdbButton.addEventListener("click", () => {
                ipcRenderer.send("stopAdb")
            })

            installButton.addEventListener("click", () => {
                let apkPath = document.getElementById("directoryField").value
                if (apkPath) {
                    installStatus.value = "Busy..."
                    ipcRenderer.send("installApk", apkPath)
                }
            })

            startButton.addEventListener("click", () => {
                installStatus.value = "Starting..."
                ipcRenderer.send("startApk", apkInput.value)
            })

            stopButton.addEventListener("click", () => {
                installStatus.value = "Stopping..."
                ipcRenderer.send("stopApk", apkInput.value)
            })

            clearButton.addEventListener("click", () => {
                installStatus.value = "Clearing..."
                ipcRenderer.send("clearApk", apkInput.value)
            })

            uninstallButton.addEventListener("click", () => {
                ipcRenderer.send("uninstallApk", apkInput.value)
            })

            typeInputButton.addEventListener("click", () => {
                ipcRenderer.send("typeTextAction", typeInput.value)
            })

            backspaceButton.addEventListener("click", () => {
                ipcRenderer.send("backspaceAction")
            })

            directoryButton.addEventListener("click", () => {
                ipcRenderer.send("openFileDialog")
            })

            ipcRenderer.on("updateDirectory", (event, arg) => {
                directoryField.value = arg
            })

            ipcRenderer.on("updateDeviceStatus", (event, arg) => {
                deviceStatus.value = `${arg}\n`
            })

            ipcRenderer.on("updateInstallStatus", (event, arg) => {
                installStatus.value = `${arg}\n`
            })

            ipcRenderer.on("updateDeviceUnitStatus", (event, arg) => {
                try {
                    let model = arg.model.split("\\")[0]
                    currentDevice.model = model
                } catch (e) {
                    deviceConnectionStatus.value = `${arg}\n`
                }
            })

            ipcRenderer.on("updateTypeInputField", (event, arg) => {
                typeInput.value = ""
            })

            ipcRenderer.on("updateConfigField", (event, arg) => {
                currentConfig = arg

                ipcRenderer.send("updateConfig", ["bungie", "gum"])
                deviceStatus.value = `${JSON.stringify(arg)}`
            })

            ipcRenderer.on("refreshConfigField", (event, arg) => {
                currentConfig = arg

                profileNamesList.options.length = 1
                for (let i = 0; i < currentConfig.deviceProfiles.length; i++) {
                    let newOpts = document.createElement("option")
                    newOpts.setAttribute("name", currentConfig.deviceProfiles[i].name)
                    newOpts.setAttribute("value", currentConfig.deviceProfiles[i].ip)
                    newOpts.setAttribute("model", currentConfig.deviceProfiles[i].model)
                    newOpts.text = `${currentConfig.deviceProfiles[i].name} | ${currentConfig.deviceProfiles[i].ip} | ${currentConfig.deviceProfiles[i].model}`
                    profileNamesList.options.add(newOpts)
                }
            })
        </script>
    </body>
</html>
